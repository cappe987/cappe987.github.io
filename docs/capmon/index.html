<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Capmon | Casper Andersson</title><meta name=keywords content><meta name=description content=" A Linux capabilities(7) monitor. Monitor capability checks to find what a command requires. Then give yourself those capabilities to run without sudo. "><meta name=author content><link rel=canonical href=https://casan.se/docs/capmon/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script src=/js/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=stylesheet href=/css/default.min.css><link rel=icon href=https://casan.se/favicon.svg><link rel=icon type=image/png sizes=16x16 href=https://casan.se/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://casan.se/favicon-32x32.png><link rel=apple-touch-icon href=https://casan.se/apple-touch-icon.png><link rel=mask-icon href=https://casan.se/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Capmon"><meta property="og:description" content=" A Linux capabilities(7) monitor. Monitor capability checks to find what a command requires. Then give yourself those capabilities to run without sudo. "><meta property="og:type" content="article"><meta property="og:url" content="https://casan.se/docs/capmon/"><meta property="article:section" content="docs"><meta property="article:published_time" content="2023-04-15T00:00:00+00:00"><meta property="article:modified_time" content="2023-04-15T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Capmon"><meta name=twitter:description content=" A Linux capabilities(7) monitor. Monitor capability checks to find what a command requires. Then give yourself those capabilities to run without sudo. "><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Documentation","item":"https://casan.se/docs/"},{"@type":"ListItem","position":2,"name":"Capmon","item":"https://casan.se/docs/capmon/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Capmon","name":"Capmon","description":" A Linux capabilities(7) monitor. Monitor capability checks to find what a command requires. Then give yourself those capabilities to run without sudo. ","keywords":[],"articleBody":"Monitor when processes check capabilities(7) to find out what they require. Run capmon to track the capabilities it requires. It’s important to not run it with sudo since that bypasses certain checks. Let the command fail at the first missing capability check and add that capability, then try again and see if if fails on more. Rinse and repeat until command runs successfully.\nIf you are not familiar with capabilities can read A simpler life without sudo.\nCapmon - GitHub\nUsing Capmon It is recommended to use Capmon without sudo, since running it with sudo the provided command inherits the sudo properties and will bypass several checks. Capmon requires CAP_DAC_OVERRIDE and CAP_SYS_ADMIN.\nTo use Capmon do\ncapmon '' For example:\ncapmon 'ip link netns add test' It is recommended to enclose the command in quotes to avoid the shell from doing any funny business with globbing or other special features. Capmon will run the command with /bin/sh.\nThe output of the above command will be\n[ip] - [PASS] CAP_DAC_OVERRIDE - [PASS] CAP_NET_ADMIN because the ip command required the capabilities CAP_NET_ADMIN and CAP_DAC_OVERRIDE for this particular task. Another example, ip link set dev tap0 up only requires CAP_NET_ADMIN.\nIf the user didn’t have the capabilities it would instead report [FAIL] on one of the capabilities. If it failed on the first of the two then it may not even show the second since commands often bail out as soon as they fail to do something.\nIf a command is still failing even though Capmon doesn’t report anything there is the flag -a or --all. This changes the place where it listens to another location which covers many more checks, some of which are not always necessary and are allowed to fail. This is not the default mode as to not confuse the user with a bunch of capabilities that usually will not matter.\nHow it works Capmon uses BPF tracepoints and fexit tracing to listen to two different events.\nCapability checks (fexit) Process starts (tracepoint) (1) looks a the return value of the capability check. By default it listens to the ns_capable and capable_wrt_inode_uidgid kernel functions. Most required capability checks go through either of these two functions. But in case it doesn’t, the --all flag changes it to instead listen to the cap_capable. The capability and the result is saved and mapped to the PID that did the check.\n(2) looks at the PID of the parent process (the one who started the new process) and if that matches with the PID of the command it is saved. Next time a process starts it will look against all previously saved PID. This ensures that any even subprocesses of subprocesses, and so on, are kept track of.\nAt the end it compares all saved PID (the process and its subprocesses) against all capability checks done and takes the intersection. The output is the capability checks done by the input command.\nCapmon itself ignores Ctrl-C (SIGINT) so it is passed down to the monitored program. This allows it to support interactive programs that are stopped with Ctrl-C.\nIt currently does not handle orphan processes since it stops once the initial command is done. To handle this there is monitor mode using the --monitor flag. This mode does not run any command, instead it behaves similar to tcpdump and can filter and output a summary based on PID or name.\n","wordCount":"567","inLanguage":"en","datePublished":"2023-04-15T00:00:00Z","dateModified":"2023-04-15T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://casan.se/docs/capmon/"},"publisher":{"@type":"Organization","name":"Casper Andersson","logo":{"@type":"ImageObject","url":"https://casan.se/favicon.svg"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://casan.se/ accesskey=h title="Casper Andersson (Alt + H)">Casper Andersson</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://casan.se/blog title=Blog><span>Blog</span></a></li><li><a href=https://casan.se/docs title=Docs><span>Docs</span></a></li><li><a href=https://casan.se/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://casan.se/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://casan.se/>Home</a>&nbsp;»&nbsp;<a href=https://casan.se/docs/>Documentation</a></div><h1 class=post-title>Capmon</h1><ul class=post-tags></ul></header><div class=post-content><p>Monitor when processes check <code>capabilities(7)</code> to find out what they require.
Run <code>capmon &lt;cmd></code> to track the capabilities it requires. It&rsquo;s important to not
run it with sudo since that bypasses certain checks. Let the command fail at the
first missing capability check and add that capability, then try again and see
if if fails on more. Rinse and repeat until command runs successfully.</p><p>If you are not familiar with capabilities can read <a href=https://casan.se/blog/linux/a-simpler-life-without-sudo/>A simpler life without
sudo</a>.</p><p><a href=https://github.com/cappe987/capmon>Capmon - GitHub</a></p><h2 id=using-capmon>Using Capmon<a hidden class=anchor aria-hidden=true href=#using-capmon>#</a></h2><p>It is recommended to use Capmon without sudo, since running it with sudo the
provided command inherits the sudo properties and will bypass several checks.
Capmon requires <code>CAP_DAC_OVERRIDE</code> and <code>CAP_SYS_ADMIN</code>.</p><p>To use Capmon do</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>capmon <span class=s1>&#39;&lt;cmd&gt;&#39;</span>
</span></span></code></pre></div><p>For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>capmon <span class=s1>&#39;ip link netns add test&#39;</span>
</span></span></code></pre></div><p>It is recommended to enclose the command in quotes to avoid the shell from
doing any funny business with globbing or other special features. Capmon will
run the command with <code>/bin/sh</code>.</p><p>The output of the above command will be</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>ip<span class=o>]</span>
</span></span><span class=line><span class=cl>- <span class=o>[</span>PASS<span class=o>]</span> CAP_DAC_OVERRIDE
</span></span><span class=line><span class=cl>- <span class=o>[</span>PASS<span class=o>]</span> CAP_NET_ADMIN
</span></span></code></pre></div><p>because the <code>ip</code> command required the capabilities <code>CAP_NET_ADMIN</code> and
<code>CAP_DAC_OVERRIDE</code> for this particular task. Another example, <code>ip link set dev tap0 up</code> only requires <code>CAP_NET_ADMIN</code>.</p><p>If the user didn&rsquo;t have the capabilities it would instead report <code>[FAIL]</code> on one
of the capabilities. If it failed on the first of the two then it may not even
show the second since commands often bail out as soon as they fail to do
something.</p><p>If a command is still failing even though Capmon doesn&rsquo;t report anything there
is the flag <code>-a</code> or <code>--all</code>. This changes the place where it listens to another
location which covers many more checks, some of which are not always necessary
and are allowed to fail. This is not the default mode as to not confuse the
user with a bunch of capabilities that usually will not matter.</p><h2 id=how-it-works>How it works<a hidden class=anchor aria-hidden=true href=#how-it-works>#</a></h2><p>Capmon uses BPF tracepoints and fexit tracing to listen to two different events.</p><ol><li>Capability checks (fexit)</li><li>Process starts (tracepoint)</li></ol><p>(1) looks a the return value of the capability check. By default it listens to
the <code>ns_capable</code> and <code>capable_wrt_inode_uidgid</code> kernel functions. Most required
capability checks go through either of these two functions. But in case it
doesn&rsquo;t, the <code>--all</code> flag changes it to instead listen to the <code>cap_capable</code>. The
capability and the result is saved and mapped to the PID that did the check.</p><p>(2) looks at the PID of the parent process (the one who started the new
process) and if that matches with the PID of the command it is saved. Next time
a process starts it will look against all previously saved PID. This ensures
that any even subprocesses of subprocesses, and so on, are kept track of.</p><p>At the end it compares all saved PID (the process and its subprocesses) against
all capability checks done and takes the intersection. The output is the
capability checks done by the input command.</p><p>Capmon itself ignores <code>Ctrl-C</code> (<code>SIGINT</code>) so it is passed down to the monitored
program. This allows it to support interactive programs that are stopped with
<code>Ctrl-C</code>.</p><p>It currently does not handle orphan processes since it stops once the initial
command is done. To handle this there is monitor mode using the <code>--monitor</code>
flag. This mode does not run any command, instead it behaves similar to
<code>tcpdump</code> and can filter and output a summary based on PID or name.</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://casan.se/>Casper Andersson</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>