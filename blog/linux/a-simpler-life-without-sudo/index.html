<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>A simpler life without sudo | Casper Andersson</title>
<meta name=keywords content="linux,programming"><meta name=description content=" Using Linux capabilities(7) to avoid using sudo, and using Capmon to figure out what capbilities are required. "><meta name=author content><link rel=canonical href=https://casan.se/blog/linux/a-simpler-life-without-sudo/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script src=/js/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=stylesheet href=/css/default.min.css><link rel=icon href=https://casan.se/favicon.svg><link rel=icon type=image/png sizes=16x16 href=https://casan.se/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://casan.se/favicon-32x32.png><link rel=apple-touch-icon href=https://casan.se/apple-touch-icon.png><link rel=mask-icon href=https://casan.se/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="A simpler life without sudo"><meta property="og:description" content=" Using Linux capabilities(7) to avoid using sudo, and using Capmon to figure out what capbilities are required. "><meta property="og:type" content="article"><meta property="og:url" content="https://casan.se/blog/linux/a-simpler-life-without-sudo/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-08-26T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-26T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="A simpler life without sudo"><meta name=twitter:description content=" Using Linux capabilities(7) to avoid using sudo, and using Capmon to figure out what capbilities are required. "><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://casan.se/blog/"},{"@type":"ListItem","position":2,"name":"Linux","item":"https://casan.se/blog/linux/"},{"@type":"ListItem","position":3,"name":"A simpler life without sudo","item":"https://casan.se/blog/linux/a-simpler-life-without-sudo/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"A simpler life without sudo","name":"A simpler life without sudo","description":" Using Linux capabilities(7) to avoid using sudo, and using Capmon to figure out what capbilities are required. ","keywords":["linux","programming"],"articleBody":"An incredibly underused but oh-so-amazing feature in Linux is capabilities. Everyone should use it to make their lives simpler.\nBy default, a user does not have many permissions on a system. Some are granted automatically through different means, such as reading and writing files in your home directory. As developers, we may regularly have to reach for sudo to allow us to do what we want. Writing our password over and over again, or constantly forgetting to prefix your command with sudo. It can get tiring.\nOn the other end, you could do like ye olden days and start a shell as a superuser; run everything with sudo. However, sudo was specifically invented to not have users run everything as a superuser, as it is inherently a bad idea. Using sudo gives you access to everything. Not using it gives you access to very little. But what if there was a middle ground?\nEnter capabilities. All of the actions that normally require sudo have one or more capabilities associated with them. Sudo grants you all capabilities, allowing for any kind of mayhem when running commands with it. However, you can also grant yourself only some of these capabilities. It is assigned per user and application. This means that to run a command that normally requires sudo without it, both the user and the command must have the required capabilities. This gives the bonus of safety, an application cannot do actions you explicitly haven’t given it access to. It also allows system administrators to give users access to run certain applications without the need to give them sudo rights.\nUsing capabilities As mentioned above, capabilities are given to both users and applications. Let’s start with users. This is stored in the file /etc/security/capability.conf. Edit the file and add a line like this but with your username.\ncap_net_raw,cap_net_admin\tcasan This gives the user casan the two capabilities cap_net_raw and cap_net_admin and should take effect immediately. Next, we need some application. Let’s use the ip command. To find where the command is located we can use which ip. An important detail here is that you can’t give capabilities to symlinks, so if a command is symlinked the capability must be given to the actual executable file.\nBut before we add the capability, let’s try doing a command without sudo. It should fail with ioctl(TUNSETIFF): Operation not permitted.\nip tuntap add tap99 mod tap Now add the capability cap_net_admin to the command.\nsudo setcap cap_net_admin+ep /bin/ip Try the previous command again and it should work. And just to clean up our mess we can delete the newly created tap99 interface with ip link del dev tap99 (which we can also do without sudo).\nNow you know how to add capabilities to avoid using sudo. But how do we know which capabilities a command needs? It can depend on which arguments you pass the command, depending on what the arguments do. If you use the commands of ip netns you need different capabilities than the example above. You can always read the manpage capabilities(7) to get a better understanding of the individual capabilities. But if you don’t fully understand how a command works it can be difficult to figure out. It can also be the case of one command starting another subprocess, where the subprocess is the one that needs the capability.\nCapmon: figuring out capabilities Introducing Capmon - a Linux capabilities monitor. A tool that monitors your process and shows a report over which capabilities it looked for. You simply pass your command as an argument to Capmon and it will execute it. But before you get started, Capmon does require the capabilities cap_dac_override and cap_sys_admin, running it with sudo does not work correctly because that bypasses certain checks. Now that you’ve added those capabilities to yourself and Capmon, let’s try it out.\ncapmon 'ip tuntap add tap99 mod tap' Assuming you did everything correctly, this should output the following text indicating that the ip application accessed the cap_net_admin capability successfully.\n[ip] - [PASS] CAP_NET_ADMIN Now take what you’ve learnt here and use more commands without sudo.\nSome things to keep in mind If a command is failing but you are not seeing any FAIL output from Capmon, try running with the flag -a. This adds some additional monitoring points. It is recommended to use quotes around your command, otherwise dash-arguments arguments will be interpreted as arguments to Capmon. Commands that require multiple capabilities will usually stop and return an error on the first failed check. In this case, add the first capability, then run it again and it will fail on the second. Footnote The title of this post is a homage to a blogpost by a former colleague who taught me about capabilities and a ton of other things, which in turn inspired me to create Capmon. You can read his post at A life without sudo.\n","wordCount":"815","inLanguage":"en","datePublished":"2022-08-26T00:00:00Z","dateModified":"2022-08-26T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://casan.se/blog/linux/a-simpler-life-without-sudo/"},"publisher":{"@type":"Organization","name":"Casper Andersson","logo":{"@type":"ImageObject","url":"https://casan.se/favicon.svg"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://casan.se/ accesskey=h title="Casper Andersson (Alt + H)">Casper Andersson</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://casan.se/blog title=Blog><span>Blog</span></a></li><li><a href=https://casan.se/docs title=Docs><span>Docs</span></a></li><li><a href=https://casan.se/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://casan.se/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://casan.se/>Home</a>&nbsp;»&nbsp;<a href=https://casan.se/blog/>Blog</a>&nbsp;»&nbsp;<a href=https://casan.se/blog/linux/>Linux</a></div><h1 class=post-title>A simpler life without sudo</h1><div class=post-meta><span title='2022-08-26 00:00:00 +0000 UTC'>August 26, 2022</span>&nbsp;·&nbsp;4 min</div><ul class=post-tags><li><a href=https://casan.se/tags/linux/>linux</a></li><li><a href=https://casan.se/tags/programming/>programming</a></li></ul></header><div class=post-content><p>An incredibly underused but oh-so-amazing feature in Linux is <em>capabilities</em>.
Everyone should use it to make their lives simpler.</p><p>By default, a user does not have many permissions on a system. Some are granted
automatically through different means, such as reading and writing files in
your home directory. As developers, we may regularly have to reach for <code>sudo</code> to
allow us to do what we want. Writing our password over and over again, or
constantly forgetting to prefix your command with sudo. It can get tiring.</p><p>On the other end, you could do like ye olden days and start a shell as a
superuser; run everything with sudo. However, sudo was specifically invented to
not have users run everything as a superuser, as it is inherently a bad idea.
Using sudo gives you access to everything. Not using it gives you access to very
little. But what if there was a middle ground?</p><p>Enter <em>capabilities</em>. All of the actions that normally require sudo have one or
more capabilities associated with them. Sudo grants you all capabilities,
allowing for any kind of mayhem when running commands with it. However, you can
also grant yourself only some of these capabilities. It is assigned per user and
application. This means that to run a command that normally requires sudo
without it, both the user and the command must have the required capabilities.
This gives the bonus of safety, an application cannot do actions you explicitly
haven&rsquo;t given it access to. It also allows system administrators to give users
access to run certain applications without the need to give them sudo rights.</p><h2 id=using-capabilities>Using capabilities<a hidden class=anchor aria-hidden=true href=#using-capabilities>#</a></h2><p>As mentioned above, capabilities are given to both users and applications. Let&rsquo;s
start with users. This is stored in the file <code>/etc/security/capability.conf</code>.
Edit the file and add a line like this but with your username.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cap_net_raw,cap_net_admin	casan
</span></span></code></pre></div><p>This gives the user <code>casan</code> the two capabilities <code>cap_net_raw</code> and
<code>cap_net_admin</code> and should take effect immediately. Next, we need some
application. Let&rsquo;s use the <code>ip</code> command. To find where the command is located we
can use <code>which ip</code>. An important detail here is that you can&rsquo;t give capabilities
to symlinks, so if a command is symlinked the capability must be given to the
actual executable file.</p><p>But before we add the capability, let&rsquo;s try doing a command without sudo. It
should fail with <code>ioctl(TUNSETIFF): Operation not permitted</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ip tuntap add tap99 mod tap
</span></span></code></pre></div><p>Now add the capability <code>cap_net_admin</code> to the command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sudo setcap cap_net_admin+ep /bin/ip
</span></span></code></pre></div><p>Try the previous command again and it should work. And just to clean up our mess
we can delete the newly created <code>tap99</code> interface with <code>ip link del dev tap99</code>
(which we can also do without sudo).</p><p>Now you know how to add capabilities to avoid using sudo. But how do we know
which capabilities a command needs? It can depend on which arguments you pass
the command, depending on what the arguments do. If you use the commands of <code>ip netns</code> you need different capabilities than the example above. You can always
read the manpage
<a href=http://man7.org/linux/man-pages/man7/capabilities.7.html>capabilities(7)</a> to
get a better understanding of the individual capabilities. But if you don&rsquo;t
fully understand how a command works it can be difficult to figure out. It can
also be the case of one command starting another subprocess, where the
subprocess is the one that needs the capability.</p><h2 id=capmon-figuring-out-capabilities>Capmon: figuring out capabilities<a hidden class=anchor aria-hidden=true href=#capmon-figuring-out-capabilities>#</a></h2><p>Introducing <a href=https://github.com/cappe987/capmon>Capmon - a Linux capabilities
monitor</a>. A tool that monitors your process
and shows a report over which capabilities it looked for. You simply pass your
command as an argument to Capmon and it will execute it. But before you get
started, Capmon does require the capabilities <code>cap_dac_override</code> and
<code>cap_sys_admin</code>, running it with sudo does not work correctly because that
bypasses certain checks. Now that you&rsquo;ve added those capabilities to yourself
and Capmon, let&rsquo;s try it out.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>capmon <span class=s1>&#39;ip tuntap add tap99 mod tap&#39;</span>
</span></span></code></pre></div><p>Assuming you did everything correctly, this should output the following text
indicating that the <code>ip</code> application accessed the <code>cap_net_admin</code> capability
successfully.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>ip<span class=o>]</span>
</span></span><span class=line><span class=cl>- <span class=o>[</span>PASS<span class=o>]</span> CAP_NET_ADMIN
</span></span></code></pre></div><p>Now take what you&rsquo;ve learnt here and use more commands without sudo.</p><h3 id=some-things-to-keep-in-mind>Some things to keep in mind<a hidden class=anchor aria-hidden=true href=#some-things-to-keep-in-mind>#</a></h3><ul><li>If a command is failing but you are not seeing any FAIL output from Capmon,
try running with the flag <code>-a</code>. This adds some additional monitoring points.</li><li>It is recommended to use quotes around your command, otherwise dash-arguments
arguments will be interpreted as arguments to Capmon.</li><li>Commands that require multiple capabilities will usually stop and return an
error on the first failed check. In this case, add the first capability, then
run it again and it will fail on the second.</li></ul><h2 id=footnote>Footnote<a hidden class=anchor aria-hidden=true href=#footnote>#</a></h2><p>The title of this post is a homage to a blogpost by a former colleague who
taught me about capabilities and a ton of other things, which in turn inspired
me to create Capmon. You can read his post at <a href=https://troglobit.com/2016/12/11/a-life-without-sudo/>A life without
sudo</a>.</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://casan.se/>Casper Andersson</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>