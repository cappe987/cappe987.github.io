<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>TSN: Time-Aware Shaper | Casper Andersson</title>
<meta name=keywords content="networks"><meta name=description content="Time Sensitive Networking and the 802.1Qbv standard"><meta name=author content><link rel=canonical href=https://casan.se/blog/networks/tsn-time-aware-shaper/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script src=/js/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=stylesheet href=/css/default.min.css><link rel=icon href=https://casan.se/favicon.svg><link rel=icon type=image/png sizes=16x16 href=https://casan.se/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://casan.se/favicon-32x32.png><link rel=apple-touch-icon href=https://casan.se/apple-touch-icon.png><link rel=mask-icon href=https://casan.se/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="TSN: Time-Aware Shaper"><meta property="og:description" content="Time Sensitive Networking and the 802.1Qbv standard"><meta property="og:type" content="article"><meta property="og:url" content="https://casan.se/blog/networks/tsn-time-aware-shaper/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-08-25T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-25T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="TSN: Time-Aware Shaper"><meta name=twitter:description content="Time Sensitive Networking and the 802.1Qbv standard"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://casan.se/blog/"},{"@type":"ListItem","position":2,"name":"Networks","item":"https://casan.se/blog/networks/"},{"@type":"ListItem","position":3,"name":"TSN: Time-Aware Shaper","item":"https://casan.se/blog/networks/tsn-time-aware-shaper/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"TSN: Time-Aware Shaper","name":"TSN: Time-Aware Shaper","description":"Time Sensitive Networking and the 802.1Qbv standard","keywords":["networks"],"articleBody":"Let’s dive a little deeper into Time-Aware Shapers, specified in the IEEE 802.1Qbv standard. For a light introduction go read my intro to TSN.\nGates The shapers are applied on egress and each shaper has a list of time slots, where each time slot specifies a duration, operation, and gate_mask. The duration represents how long the time slot is. The gate_mask specifies which egress queues are open during that time. Multiple queues can be open at the same time, at which point it treats it as regular Strict Priority between those queues, i.e., higher priority goes first. operation will be covered later. Time-Aware Shapers can have a theoretically infinite number of these time slots, also known as gates, but in practice there will of course be a limit to what both the software and hardware can support. The sum of the gates’ durations defines the cycle time. When it has iterated through all the gates it restarts with the first gate again. Below is an example of a schedule with two gates, one which opens priorities 0-3 and one which opens priorities 4-7.\n|---------|---------|---------|---------| | 0,1,2,3 | 4,5,6,7 | 0,1,2,3 | 4,5,6,7 | ... |---------|---------|---------|---------| You should always make sure that all possible priorities in your system should be able to send at least during one gate. Otherwise it will take up space in the queue and never be sent. You can of course use only priorities 0-2 if you wish, but then you must make sure that no priority is ever mapped to the rest. The priority is usually the PCP or DSCP value, but how you map that to the internal priority of the switch is up to you. Since DSCP can have 64 different values you already need some sort of reduced mapping to the 8 queues used by the shaper.\nThe lower limit of what defines reasonable durations is that frames need to still be able to pass through with little interruption. Too short and it will start causing more problems that it solves. With too short gates it could result in frames either not fitting in the gate and start encroaching on the next time slot, or being preempted a lot if used with Frame Preemption.\nThe maximum latency for your requirements defines the upper limit of a single gate’s duration A low-priority gate cannot have a duration longer than the maximum latency, otherwise the higher priorities has to wait too long for their turn. The total cycle time has no theoretical upper limit, but at some point it will be more worth to have it cycle back to the start instead of defining more gates.\nAll gates have a guard band at the end of their duration. During the guard band no new frames can be sent, it only allows already started frames to finish. This is to avoid frames encroaching on the next time slot. To completely avoid it you can set the guard band to the maximum size of a frame, 1518 bytes. This means that if the frame started sending it will be guaranteed to finish before the gate closes. However, this could end up wasting a lot of time when a frame finishes very early into the guard band and it has to idle until the next gate.\n|------------------|-------------| | Gate 1 | GB | Gate 2 | GB | |------------------|-------------| Frame Preemption Frame Preemption can be used in conjunction with Time-Aware Shapers to make them more efficient. Frame preemption was covered briefly in the TSN introduction post. A quick recap. It requires frames to be classified as express or non-express frames. It allows non-express frames to be interrupted by express frames to allow the express frame to send immediately.\nWhen used with Time-Aware Shaper you apply the different Frame Preemption options SetGateStates (S), Set-And-Hold-MAC (H), and Set-And-Release-MAC (R) to the different gates. S does nothing with respect to Frame Preemption, but is an indicator that the guard band needs to be longer before it starts. H makes sure any frames from previous gate are preempted when the gate starts. R allows non-express frames to send again. H allows the guard bands to be reduced drastically because now they can preempt a frame when reached. It only needs to add the extra CRC checksum and then it can move on to the next gate. Shorter guard bands enables better bandwidth usage.\nIf you have multiple express gates (H) in a row then it won’t be able to preempt in preparation for the next gate, but then you also have bad design :).\n","wordCount":"762","inLanguage":"en","datePublished":"2022-08-25T00:00:00Z","dateModified":"2022-08-25T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://casan.se/blog/networks/tsn-time-aware-shaper/"},"publisher":{"@type":"Organization","name":"Casper Andersson","logo":{"@type":"ImageObject","url":"https://casan.se/favicon.svg"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://casan.se/ accesskey=h title="Casper Andersson (Alt + H)">Casper Andersson</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://casan.se/blog title=Blog><span>Blog</span></a></li><li><a href=https://casan.se/docs title=Docs><span>Docs</span></a></li><li><a href=https://casan.se/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://casan.se/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://casan.se/>Home</a>&nbsp;»&nbsp;<a href=https://casan.se/blog/>Blog</a>&nbsp;»&nbsp;<a href=https://casan.se/blog/networks/>Networks</a></div><h1 class=post-title>TSN: Time-Aware Shaper</h1><div class=post-meta>&lt;span title='2022-08-25 00:00:00 +0000 UTC'>August 25, 2022&lt;/span>&amp;nbsp;·&amp;nbsp;4 min</div><ul class=post-tags><li><a href=https://casan.se/tags/networks/>networks</a></li></ul></header><div class=post-content><p>Let&rsquo;s dive a little deeper into Time-Aware Shapers, specified in the
IEEE 802.1Qbv standard. For a light introduction go read my <a href=https://casan.se/blog/networks/what-is-time-sensitive-networking/>intro to
TSN</a>.</p><h2 id=gates>Gates<a hidden class=anchor aria-hidden=true href=#gates>#</a></h2><p>The shapers are applied on egress and each shaper has a list of time slots,
where each time slot specifies a <code>duration</code>, <code>operation</code>, and <code>gate_mask</code>. The
<code>duration</code> represents how long the time slot is. The <code>gate_mask</code> specifies
which egress queues are open during that time. Multiple queues can be
open at the same time, at which point it treats it as regular Strict Priority
between those queues, i.e., higher priority goes first. <code>operation</code> will be
covered later. Time-Aware Shapers can have a theoretically infinite number of
these time slots, also known as <strong>gates</strong>, but in practice there will of course
be a limit to what both the software and hardware can support. The sum of the
gates&rsquo; durations defines the cycle time. When it has iterated through all the
gates it restarts with the first gate again. Below is an example of a schedule
with two gates, one which opens priorities 0-3 and one which opens priorities
4-7.</p><pre tabindex=0><code class=language-no-hl data-lang=no-hl>|---------|---------|---------|---------|
| 0,1,2,3 | 4,5,6,7 | 0,1,2,3 | 4,5,6,7 | ...
|---------|---------|---------|---------|
</code></pre><p>You should always make sure that all possible priorities in your system should
be able to send at least during one gate. Otherwise it will take up space in the
queue and never be sent. You can of course use only priorities 0-2 if you wish,
but then you must make sure that no priority is ever mapped to the rest. The
priority is usually the PCP or DSCP value, but how you map that to the internal
priority of the switch is up to you. Since DSCP can have 64 different values you
already need some sort of reduced mapping to the 8 queues used by the shaper.</p><p>The lower limit of what defines reasonable durations is that frames need to
still be able to pass through with little interruption. Too short and it will
start causing more problems that it solves. With too short gates it could result
in frames either not fitting in the gate and start encroaching on the next time
slot, or being preempted a lot if used with Frame Preemption.</p><p>The maximum latency for your requirements defines the upper limit of a single
gate&rsquo;s duration A low-priority gate cannot have a duration longer than the
maximum latency, otherwise the higher priorities has to wait too long for their
turn. The total cycle time has no theoretical upper limit, but at some point it
will be more worth to have it cycle back to the start instead of defining more
gates.</p><p>All gates have a guard band at the end of their duration. During the guard band
no new frames can be sent, it only allows already started frames to finish. This
is to avoid frames encroaching on the next time slot. To completely avoid it you
can set the guard band to the maximum size of a frame, 1518 bytes. This means
that if the frame started sending it will be guaranteed to finish before the
gate closes. However, this could end up wasting a lot of time when a frame
finishes very early into the guard band and it has to idle until the next gate.</p><pre tabindex=0><code class=language-no-hl data-lang=no-hl>|------------------|-------------|
|    Gate 1   | GB | Gate 2 | GB |
|------------------|-------------|
</code></pre><h2 id=frame-preemption>Frame Preemption<a hidden class=anchor aria-hidden=true href=#frame-preemption>#</a></h2><p>Frame Preemption can be used in conjunction with Time-Aware Shapers to make
them more efficient. Frame preemption was covered briefly in the TSN
introduction post. A quick recap. It requires frames to be classified as express
or non-express frames. It allows non-express frames to be interrupted by express
frames to allow the express frame to send immediately.</p><p>When used with Time-Aware Shaper you apply the different Frame Preemption
options SetGateStates (<code>S</code>), Set-And-Hold-MAC (<code>H</code>), and Set-And-Release-MAC
(<code>R</code>) to the different gates. <code>S</code> does nothing with respect to Frame Preemption,
but is an indicator that the guard band needs to be longer before it starts. <code>H</code>
makes sure any frames from previous gate are preempted when the gate starts. <code>R</code>
allows non-express frames to send again. <code>H</code> allows the guard bands to be
reduced drastically because now they can preempt a frame when reached. It only
needs to add the extra CRC checksum and then it can move on to the next gate.
Shorter guard bands enables better bandwidth usage.</p><p>If you have multiple express gates (<code>H</code>) in a row then it won&rsquo;t be able to
preempt in preparation for the next gate, but then you also have bad design :).</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://casan.se/>Casper Andersson</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>