<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>The day Make started crashing &#183; Casper Andersson</title><meta name=title content="The day Make started crashing &#183; Casper Andersson"><meta name=keywords content="programming,linux,"><link rel=canonical href=https://casan.se/blog/the-day-make-started-crashing/><link type=text/css rel=stylesheet href=/css/main.bundle.min.591a39234db91c6e7f9e637e3baefe87c3c330f6a173e697901b0fadf676d5534029ee51273b82fa39c07b9a92420dd9f83c1531c8556426e146b0591dfaca40.css integrity="sha512-WRo5I025HG5/nmN+O67+h8PDMPahc+aXkBsPrfZ21VNAKe5RJzuC+jnAe5qSQg3Z+DwVMchVZCbhRrBZHfrKQA=="><script type=text/javascript src=/js/appearance.min.a75d508cf75a202afc48fe649516720f8036bda3657897f6cc07dab21f94fa9c3933edbbfc2936f8d3a426f45ac6153237a48aec9115147c5e03db1c5b62b8bc.js integrity="sha512-p11QjPdaICr8SP5klRZyD4A2vaNleJf2zAfash+U+pw5M+27/Ck2+NOkJvRaxhUyN6SK7JEVFHxeA9scW2K4vA=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.911bd9741247c092f3a38757ca26b07e6bf319209e5162bbc5a609bae50fa2ea13b3c09f8f2c3d1cfd66c0b6885f0b2137bb43fee6404db177d90abde3c09547.js integrity="sha512-kRvZdBJHwJLzo4dXyiawfmvzGSCeUWK7xaYJuuUPouoTs8Cfjyw9HP1mwLaIXwshN7tD/uZATbF32Qq948CVRw==" data-copy data-copied></script>
<script src=/js/zoom.min.js></script>
<link rel=icon type=image/svg href=/favicon.svg><link rel=manifest href=/site.webmanifest><meta property="og:title" content="The day Make started crashing"><meta property="og:description" content="The last thing you want is for your build system to crash"><meta property="og:type" content="article"><meta property="og:url" content="https://casan.se/blog/the-day-make-started-crashing/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-09-17T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-17T00:00:00+00:00"><meta property="og:site_name" content="Casper Andersson"><meta name=twitter:card content="summary"><meta name=twitter:title content="The day Make started crashing"><meta name=twitter:description content="The last thing you want is for your build system to crash"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Blog","name":"The day Make started crashing","headline":"The day Make started crashing","description":"The last thing you want is for your build system to crash","abstract":"This is a short story from $DAYJOB about my discovery and investigations of an issue with the build system.\nOne day when building our code I suddenly got a segmentation fault when building. An odd occurrence. I could not recall any changes to the build system and checking the Git log I could not find any changes that would affect it.","inLanguage":"en","url":"https:\/\/casan.se\/blog\/the-day-make-started-crashing\/","author":{"@type":"Person","name":"Casper Andersson"},"copyrightYear":"2022","dateCreated":"2022-09-17T00:00:00\u002b00:00","datePublished":"2022-09-17T00:00:00\u002b00:00","dateModified":"2022-09-17T00:00:00\u002b00:00","keywords":["programming","linux"],"mainEntityOfPage":"true","wordCount":"934"}]</script><meta name=author content="Casper Andersson"><link href=https://github.com/cappe987 rel=me><script src=/lib/jquery/jquery.slim.min.js integrity></script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 pl-[24px] pr-[24px]" style=z-index:100><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div><div class="relative max-w-[64rem] ml-auto mr-auto"><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3"><div><a href=/ class=flex><span class=sr-only>Casper Andersson</span>
<img src=/img/ghost.png width=245 height=245 class="max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="Casper Andersson"></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">Casper Andersson</a></nav><nav class="hidden md:flex items-center space-x-5 md:ml-12"><a href=/blog/ class="flex items-center"><p class="text-base font-medium text-gray-500 hover:text-gray-900" title=Blog>Blog</p></a><a href=/docs/ class="flex items-center"><p class="text-base font-medium text-gray-500 hover:text-gray-900" title=Documentation>Docs</p></a><a href=/tags/ class="flex items-center"><p class="text-base font-medium text-gray-500 hover:text-gray-900" title=Tags>Tags</p></a><a href=/about/ class="flex items-center"><p class="text-base font-medium text-gray-500 hover:text-gray-900" title="About Me">About Me</p></a></nav><div class="flex md:hidden items-center space-x-5 md:ml-12"><span></span></div></div><div class="-my-2 -mr-2 md:hidden"><label id=menu-button for=menu-controller class=block><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-auto overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/blog/ class="flex items-center"><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title=Blog>Blog</p></a></li><li class=mt-1><a href=/docs/ class="flex items-center"><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title=Documentation>Docs</p></a></li><li class=mt-1><a href=/tags/ class="flex items-center"><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title=Tags>Tags</p></a></li><li class=mt-1><a href=/about/ class="flex items-center"><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title="About Me">About Me</p></a></li></ul></div></label></div></div></div></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("menu-blur");n.style.opacity=t/300})</script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom" style=background-image:url(/img/bg6_hu917d3663dd0ee4c1b9afd519cbf0a754_418075_1200x0_resize_q75_box.jpg)><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("background-blur");n.style.opacity=t/300})</script><header id=single_header class="mt-5 max-w-prose"><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>Casper Andersson</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/blog/>Blog</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/blog/the-day-make-started-crashing/>The day Make started crashing</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">The day Make started crashing</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2022-09-17 00:00:00 +0000 UTC">17 September 2022</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">5 mins</span></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/programming/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">programming</span></span></span>
<span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/linux/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">linux</span></span></span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-prose"><p>This is a short story from <code>$DAYJOB</code> about my discovery and investigations of
an issue with the build system.</p><p>One day when building our code I suddenly got a segmentation fault when
building. An odd occurrence. I could not recall any changes to the build system
and checking the Git log I could not find any changes that would affect it. It
got even more mysterious as I went back in the Git history and would still have
the crash. I managed to narrow the issue down to one package which was being
built slightly differently than our other packages. Still, it didn&rsquo;t make sense
why it was failing.</p><p>The weirdest part of all this was that it was failing <em>between</em> two steps in the
build process. I added debug prints to the build system and I could see that it
finished the configuration step, but never reached the start of the build step.
I did not dig deeper into the build system here, as it is very complex Makefile
code. At this point, I knew there was some issue with Make. It output a core
dump upon crashing, so my next step was to take a look at that core dump. Find
out how it is crashing.</p><p>The core dump led me to a function called <code>func_filter_filterout</code>, which had a
loop that looked like this (shortened):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>while</span> <span class=p>((</span><span class=n>p</span> <span class=o>=</span> <span class=nf>find_next_token</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>word_iterator</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>len</span><span class=p>))</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>a_word</span> <span class=o>*</span><span class=n>word</span> <span class=o>=</span> <span class=nf>alloca</span> <span class=p>(</span><span class=k>sizeof</span> <span class=p>(</span><span class=k>struct</span> <span class=n>a_word</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>wordtail</span> <span class=o>=</span> <span class=n>word</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>wordtail</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>word</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>word</span><span class=o>-&gt;</span><span class=n>str</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
</span></span></code></pre></div><p>The crash would occur on the last line, but the key here is the function call to
<code>alloca</code>. It allocates memory similar to <code>malloc</code>, with the difference that the
allocation happens on the stack. This allows the memory to later be freed
automatically when the function exits. Reading the manpage
<a href=https://man7.org/linux/man-pages/man3/alloca.3.html target=_blank>alloca(3)</a> we can find</p><pre tabindex=0><code>BUGS
       There is no error indication if the stack frame cannot
       be extended. (However, after a failed allocation, the
       program is likely to receive a SIGSEGV signal if it
       attempts to access the unallocated space.)
</code></pre><p>This is exactly what was happening. When printing the <code>word</code> address in the code
above I could see the address going up and down a lot (indicating it was
allocating for a while, then freeing and the function being called again). When
it reached the point where Make would crash I noticed the address increasing
continuously for a while and eventually crashing.</p><p>Curious as to why it was stuck in a seemingly infinite loop, or as it turns out,
just a very long one I changed my print to output <code>p</code>, the strings being
iterated over. The output showed Make variables for <em>many</em> packages, and many
we did not use. The packages were available for selection in the build system
but were not selected and it did not make sense why Make would iterate over them
when building a completely unrelated package. It did not do this iteration at
all when building other packages.</p><p>For some reason, Make would start iterating over all variables. I did not delve
further into this right now. I switched focus. Why did it start happening now?
Why was it never an issue before?</p><p>It didn&rsquo;t take too long for me to realize that a couple of weeks prior I had
upgraded Ubuntu on my work laptop from 21.04 to 22.04. Could they have upgraded
the Make version? Nope, Make 4.3 was released about 3 years ago and has not had
a new release. I talked to a colleague who was still on Ubuntu 21.04 and we both
had the Make 4.3. He sent me his Make binary for me to test. Surprisingly,
it works fine. Make 4.2.1 from Ubuntu 18.04 also works fine. It is not the
environment that is the issue. Something with the Make version shipped with
Ubuntu 22.04 is different. Well, maybe Ubuntu has some internal patches to Make
that introduced the bug? Let&rsquo;s try building Make 4.3 from source!</p><p>CRASH! The issue exists on the original release too?! Had Ubuntu fixed this
previously and now removed the fix? Are there differences in how it&rsquo;s built?
Even more questions I have yet to find an answer to.</p><p>Testing it with upstream Make did not cause the crash, but a lot has been
refactored since the last release of Make.</p><p>At this point, I turned away from chasing Make. At least using upstream works
fine. Being forced to build with tools from older Ubuntu versions would be awful
in the long run. It could end up with the build system using a Docker container
with Ubuntu 21.04 to build it for many years in the future.</p><p>I turned my attention back to the &ldquo;faulty&rdquo; package in our build system. Since it
was never really handled in an ideal way I decided to dig into that instead,
resulting in the package being split up and treated the same as every package
should be treated in the build system.</p><p>Only after doing this did I discover this piece of Make code: <code>$(.VARIABLES)</code>. I
realize I should have looked closer at this code earlier, but at a glance the
code around it didn&rsquo;t do anything groundbreaking. It turns out this is a special
variable in Make that holds all other variables&rsquo; names, and it was being
iterated over.</p><p>I still have not found out why it suddenly became an issue on Ubuntu 22, but at
least I found what caused the issue. This journey has been a very interesting
and educational one. I learnt a lot about our build system and Make in general.
Time well spent!</p></br></br></div><script>var oid="views_blog/programming/2022-09-17-the-day-make-started-crashing.md",oid_likes="likes_blog/programming/2022-09-17-the-day-make-started-crashing.md"</script><script type=text/javascript src=/js/page.min.0e49973b4ad0a382c7c6012d8bff8226316642daabc4f8a20477bd08674f3da6e2fa993bc20ad4f51e7c5bb68e6f913a207a7c4fe37ea0e7b806894afce0a64e.js integrity="sha512-DkmXO0rQo4LHxgEti/+CJjFmQtqrxPiiBHe9CGdPPabi+pk7wgrU9R58W7aOb5E6IHp8T+N+oOe4BolK/OCmTg=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt="Casper Andersson" src=/img/ghost_hua467e0f5394043115cc2fd743cdf1bb4_14575_192x192_fill_box_center_3.png><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Casper Andersson</div><div class="text-sm text-neutral-700 dark:text-neutral-400">I&rsquo;m a software developer</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/cappe987 target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></div></div></div></div></footer></article></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2023
Casper Andersson</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.2166d3adac1679c00a75161830ab5725d3efc0e3d3f8c2453fb01d0907948436c25f0f8a7ad824322fa22f3f9c85fd4d0a1d5c856f53b862157da25a57dc3d52.js integrity="sha512-IWbTrawWecAKdRYYMKtXJdPvwOPT+MJFP7AdCQeUhDbCXw+KetgkMi+iLz+chf1NCh1chW9TuGIVfaJaV9w9Ug=="></script></footer></div></body></html>