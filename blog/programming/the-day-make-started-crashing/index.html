<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>The day Make started crashing | Casper Andersson</title>
<meta name=keywords content="programming,linux"><meta name=description content="The last thing you want is for your build system to crash"><meta name=author content><link rel=canonical href=https://casan.se/blog/programming/the-day-make-started-crashing/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script src=/js/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=stylesheet href=/css/default.min.css><link rel=icon href=https://casan.se/favicon.svg><link rel=icon type=image/png sizes=16x16 href=https://casan.se/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://casan.se/favicon-32x32.png><link rel=apple-touch-icon href=https://casan.se/apple-touch-icon.png><link rel=mask-icon href=https://casan.se/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://casan.se/blog/programming/the-day-make-started-crashing/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="The day Make started crashing"><meta property="og:description" content="The last thing you want is for your build system to crash"><meta property="og:type" content="article"><meta property="og:url" content="https://casan.se/blog/programming/the-day-make-started-crashing/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-09-17T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-17T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="The day Make started crashing"><meta name=twitter:description content="The last thing you want is for your build system to crash"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://casan.se/blog/"},{"@type":"ListItem","position":2,"name":"Programming","item":"https://casan.se/blog/programming/"},{"@type":"ListItem","position":3,"name":"The day Make started crashing","item":"https://casan.se/blog/programming/the-day-make-started-crashing/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"The day Make started crashing","name":"The day Make started crashing","description":"The last thing you want is for your build system to crash","keywords":["programming","linux"],"articleBody":"This is a short story from $DAYJOB about my discovery and investigations of an issue with the build system.\nOne day when building our code I suddenly got a segmentation fault when building. That’s odd! I could not recall any changes to the build system and checking the Git log I could not find any changes that could possibly affect it. The mystery grew as I checked out older Git commits and would still have the crash. I managed to narrow the issue down to one package which was being built slightly differently than other packages. Still, it didn’t make sense to me why it was failing.\nWhat confused me the most was that it was failing between two steps in the build process. I added debug prints to the build system and I could see that it finished the configuration step, but never reached the start of the build step. I did not dig deeper into the build system here. At this point, I suspected there was some issue with GNU Make. It output a core dump upon crashing, so my next step was to take a look at that core dump. Find out how it is crashing.\nThe core dump led me to a function called func_filter_filterout, which had a loop that looked like this.\nwhile ((p = find_next_token (\u0026word_iterator, \u0026len)) != 0) { struct a_word *word = alloca (sizeof (struct a_word)); *wordtail = word; wordtail = \u0026word-\u003enext; word-\u003estr = p; // ... The crash would occur on the last line, but the key here is the function call to alloca. It allocates memory similar to malloc, with the difference that the allocation happens on the stack. This allows the memory to later be freed automatically when the function exits. Reading the manpage alloca(3) I found the following.\nBUGS There is no error indication if the stack frame cannot be extended. (However, after a failed allocation, the program is likely to receive a SIGSEGV signal if it attempts to access the unallocated space.) To verify that this was what I saw I printed the address of word. Doing so I could see the address going up and down a lot, indicating it was allocating for a while before returning the function and freeing, then being called again. When it reached the point where Make would crash I noticed the address increasing continuously for a while and eventually crashing.\nCurious as to why it was stuck in a seemingly infinite loop I changed my print to output p, the strings being iterated over. The output showed Make variables for many packages. Even packages not in use. It did not make sense why Make would iterate over them when building a completely unrelated package. It did not do this iteration at all when building other packages.\nFor some reason, Make would start iterating over all variables. I did not delve further into this right now, though I probably should have. I switched focus. Why did it start happening now? Why was it never an issue before?\nIt didn’t take too long for me to realize that a couple of weeks prior I had upgraded Ubuntu on my work laptop from 21.04 to 22.04. Could they have upgraded the Make version? Nope, Make 4.3 was released about 3 years ago and has not had a new release. I talked to a colleague who was still on Ubuntu 21.04 and we both had the Make 4.3. He sent me his Make binary for me to test. Surprisingly, it works fine. Make 4.2.1 from Ubuntu 18.04 also works fine. It is not the environment that is the issue. Something with the Make version shipped with Ubuntu 22.04 is different. Well, maybe Ubuntu has some internal patches to Make that introduced the bug? Let’s try building Make 4.3 from source!\nCRASH! What!? The issue exists on the original release too?! Had Ubuntu fixed this previously and now removed the fix? Are there differences in how it’s built? Even more questions I have yet to find an answer to.\nTesting it with upstream Make did not cause the crash, but a lot has been refactored since the last release of Make.\nAt this point, I turned away from chasing Make. At least using upstream works fine. Being forced to build with tools from older Ubuntu versions would be awful in the long run. It could end up with the build system using a Docker container with Ubuntu 21.04 to build it for many years in the future.\nI turned my attention back to the “faulty” package in our build system. Since it was never really handled in an ideal way I decided to dig into that instead.\nOnly after doing this did I discover this piece of Make code: $(.VARIABLES) that was used as input to the filter function, which made sense given that it matched with the name of the function responsible for the segmentation fault. I should have looked closer at this code earlier, but at a glance the code around it didn’t do anything groundbreaking. It turns out this is a special variable in Make that holds all other variables’ names, and it was being iterated over.\nI still have not found out why it suddenly became an issue on Ubuntu 22, but at least I found what caused the issue. This journey has been a very interesting and educational one. Build tools are the last thing you expect to crash when writing code.\n","wordCount":"912","inLanguage":"en","datePublished":"2022-09-17T00:00:00Z","dateModified":"2022-09-17T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://casan.se/blog/programming/the-day-make-started-crashing/"},"publisher":{"@type":"Organization","name":"Casper Andersson","logo":{"@type":"ImageObject","url":"https://casan.se/favicon.svg"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://casan.se/ accesskey=h title="Casper Andersson (Alt + H)">Casper Andersson</a><div class=logo-switches><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://casan.se/blog title=Blog><span>Blog</span></a></li><li><a href=https://casan.se/docs title=Docs><span>Docs</span></a></li><li><a href=https://casan.se/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://casan.se/about/ title="About Me"><span>About Me</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://casan.se/>Home</a>&nbsp;»&nbsp;<a href=https://casan.se/blog/>Blog</a>&nbsp;»&nbsp;<a href=https://casan.se/blog/programming/>Programming</a></div><h1 class=post-title>The day Make started crashing</h1><div class=post-meta><span title='2022-09-17 00:00:00 +0000 UTC'>September 17, 2022</span>&nbsp;·&nbsp;5 min</div><ul class=post-tags><li><a href=https://casan.se/tags/programming/>Programming</a></li><li><a href=https://casan.se/tags/linux/>Linux</a></li></ul></header><div class=post-content><p>This is a short story from <code>$DAYJOB</code> about my discovery and investigations of
an issue with the build system.</p><p>One day when building our code I suddenly got a segmentation fault when
building. That&rsquo;s odd! I could not recall any changes to the build system and
checking the Git log I could not find any changes that could possibly affect
it. The mystery grew as I checked out older Git commits and would still have
the crash. I managed to narrow the issue down to one package which was being
built slightly differently than other packages. Still, it didn&rsquo;t make sense to
me why it was failing.</p><p>What confused me the most was that it was failing <em>between</em> two steps in the
build process. I added debug prints to the build system and I could see that it
finished the configuration step, but never reached the start of the build step.
I did not dig deeper into the build system here. At this point, I suspected
there was some issue with GNU Make. It output a core dump upon crashing, so my
next step was to take a look at that core dump. Find out how it is crashing.</p><p>The core dump led me to a function called <code>func_filter_filterout</code>, which had a
loop that looked like this.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>while</span> <span class=p>((</span><span class=n>p</span> <span class=o>=</span> <span class=nf>find_next_token</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>word_iterator</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>len</span><span class=p>))</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>a_word</span> <span class=o>*</span><span class=n>word</span> <span class=o>=</span> <span class=nf>alloca</span> <span class=p>(</span><span class=k>sizeof</span> <span class=p>(</span><span class=k>struct</span> <span class=n>a_word</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>wordtail</span> <span class=o>=</span> <span class=n>word</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>wordtail</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>word</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>word</span><span class=o>-&gt;</span><span class=n>str</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ...
</span></span></span></code></pre></div><p>The crash would occur on the last line, but the key here is the function call
to <code>alloca</code>. It allocates memory similar to <code>malloc</code>, with the difference that
the allocation happens on the stack. This allows the memory to later be freed
automatically when the function exits. Reading the manpage
<a href=https://man7.org/linux/man-pages/man3/alloca.3.html>alloca(3)</a> I found the
following.</p><pre tabindex=0><code class=language-no-hl data-lang=no-hl>BUGS
       There is no error indication if the stack frame cannot
       be extended. (However, after a failed allocation, the
       program is likely to receive a SIGSEGV signal if it
       attempts to access the unallocated space.)
</code></pre><p>To verify that this was what I saw I printed the address of <code>word</code>. Doing so I
could see the address going up and down a lot, indicating it was allocating for
a while before returning the function and freeing, then being called again.
When it reached the point where Make would crash I noticed the address
increasing continuously for a while and eventually crashing.</p><p>Curious as to why it was stuck in a seemingly infinite loop I changed my print
to output <code>p</code>, the strings being iterated over. The output showed Make
variables for many packages. Even packages not in use. It did not make sense
why Make would iterate over them when building a completely unrelated package.
It did not do this iteration at all when building other packages.</p><p>For some reason, Make would start iterating over all variables. I did not delve
further into this right now, though I probably should have. I switched focus.
Why did it start happening now? Why was it never an issue before?</p><p>It didn&rsquo;t take too long for me to realize that a couple of weeks prior I had
upgraded Ubuntu on my work laptop from 21.04 to 22.04. Could they have upgraded
the Make version? Nope, Make 4.3 was released about 3 years ago and has not had
a new release. I talked to a colleague who was still on Ubuntu 21.04 and we both
had the Make 4.3. He sent me his Make binary for me to test. Surprisingly,
it works fine. Make 4.2.1 from Ubuntu 18.04 also works fine. It is not the
environment that is the issue. Something with the Make version shipped with
Ubuntu 22.04 is different. Well, maybe Ubuntu has some internal patches to Make
that introduced the bug? Let&rsquo;s try building Make 4.3 from source!</p><p>CRASH! What!? The issue exists on the original release too?! Had Ubuntu fixed this
previously and now removed the fix? Are there differences in how it&rsquo;s built?
Even more questions I have yet to find an answer to.</p><p>Testing it with upstream Make did not cause the crash, but a lot has been
refactored since the last release of Make.</p><p>At this point, I turned away from chasing Make. At least using upstream works
fine. Being forced to build with tools from older Ubuntu versions would be awful
in the long run. It could end up with the build system using a Docker container
with Ubuntu 21.04 to build it for many years in the future.</p><p>I turned my attention back to the &ldquo;faulty&rdquo; package in our build system. Since it
was never really handled in an ideal way I decided to dig into that instead.</p><p>Only after doing this did I discover this piece of Make code: <code>$(.VARIABLES)</code>
that was used as input to the <code>filter</code> function, which made sense given that it
matched with the name of the function responsible for the segmentation fault. I
should have looked closer at this code earlier, but at a glance the code around
it didn&rsquo;t do anything groundbreaking. It turns out this is a special variable in
Make that holds all other variables&rsquo; names, and it was being iterated over.</p><p>I still have not found out why it suddenly became an issue on Ubuntu 22, but at
least I found what caused the issue. This journey has been a very interesting
and educational one. Build tools are the last thing you expect to crash when
writing code.</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://casan.se/>Casper Andersson</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>